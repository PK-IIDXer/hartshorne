# .github/workflows/latex.yml

name: Build and Release PDF

on:
  push:
    branches:
      - master

permissions:
  contents: write 

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    steps:
      # ステップ1: .tex や .latexmkrc, Dockerfile をチェックアウト
      - name: Check out repository
        uses: actions/checkout@v4

      # ステップ2: Dockerfile からビルドイメージを構築
      - name: Build local Docker image
        run: docker build -t local-tex-builder .

      # ステップ3: ビルドした Docker イメージを使ってコンパイル
      - name: Compile LaTeX document
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/work" \
            -w /work \
            local-tex-builder \
            latexmk main.tex
            
          # (補足)
          # 1. コンテナを /work で起動
          # 2. .tex ファイル群をホストから /work にマウント
          # 3. latexmk が /work にある .latexmkrc (ステップ2でコピー済) を読み込む
          # 4. .latexmkrc の設定通り、/work/build/main.pdf が生成される
      
      # ステップ4: 'test' タグを現在のコミットに強制更新
      - name: Update 'test' tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag -f test
          git push -f origin refs/tags/test

      # ステップ5: 'test' リリースを更新
      - name: Update 'test' Release with PDF
        uses: softprops/action-gh-release@v2
        with:
          tag_name: test
          name: "Latest Development Build (test)"
          body: "masterブランチから自動ビルドされた最新のPDFです。"
          prerelease: true
          # .latexmkrc の $out_dir = 'build' に基づくパス
          files: build/main.pdf